<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABBå·®åŠ¨ä¿æŠ¤æ ¡éªŒå·¥å…·</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(102, 126, 234, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .panel-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .radio-item:hover {
            background: #f8f9fa;
        }

        .radio-item input[type="radio"] {
            width: auto;
            margin: 0;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid #667eea;
        }

        .result-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .result-content {
            white-space: pre-line;
            font-family: 'Courier New', monospace;
            color: #555;
            line-height: 1.6;
        }

        .error {
            background: #fff5f5;
            border-left-color: #e53e3e;
            color: #e53e3e;
        }

        .success {
            background: #f0fff4;
            border-left-color: #38a169;
            color: #38a169;
        }

        .selected-point-display {
            background: #e8f4f8;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 2px solid #667eea;
        }

        .selected-point-info {
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .chart-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .chart-modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            height: 80%;
            display: flex;
            flex-direction: column;
        }

        .chart-modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-modal-header h3 {
            color: #333;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .chart-container {
            flex: 1;
            padding: 20px;
            position: relative;
        }

        .chart-container canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .chart-modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            text-align: center;
        }

        .chart-modal-footer p {
            color: #666;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .grid-container {
                grid-template-columns: 1fr;
            }

            .chart-modal-content {
                width: 95%;
                height: 85%;
            }

            .chart-container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ ABBå·®åŠ¨ä¿æŠ¤æ ¡éªŒå·¥å…·</h1>
            <p>SPAD346Cå·®åŠ¨ç»¼åˆä¿æŠ¤å™¨ç‰¹æ€§æ›²çº¿æ ¡éªŒè¾…åŠ©å·¥å…·</p>
        </div>

        <div class="grid-container">
            <!-- æ›²çº¿å®šå€¼é¢æ¿ -->
            <div class="panel">
                <div class="panel-title">ğŸ“ˆ æ›²çº¿å®šå€¼</div>
                <div class="form-group">
                    <label for="P_IN">å·®åŠ¨å¯åŠ¨ç”µæµå€æ•° (P_IN):</label>
                    <input type="number" id="P_IN" name="P_IN" value="0.36" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="S">åˆ¶åŠ¨æ–œç‡ (S):</label>
                    <input type="number" id="S" name="S" value="0.44" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="I2TP">æ‹ç‚¹ç”µæµå€æ•° (I2TP):</label>
                    <input type="number" id="I2TP" name="I2TP" value="2.1" step="0.1" min="0">
                </div>
                <div class="form-group">
                    <label for="ID_IN_HIGH_SET">é«˜è®¾å®š (ID_IN_HIGH_SET):</label>
                    <input type="number" id="ID_IN_HIGH_SET" name="ID_IN_HIGH_SET" value="6" step="0.1" min="0">
                </div>
            </div>

            <!-- ç°åœºé…ç½®é¢æ¿ -->
            <div class="panel">
                <div class="panel-title">ğŸ“Š ç°åœºé…ç½®</div>
                <div class="form-group">
                    <label for="IN">ä¿æŠ¤å™¨é¢å®šç”µæµ (IN):</label>
                    <input type="number" id="IN" name="IN" value="5" step="0.1" min="0.1">
                </div>
                <div class="form-group">
                    <label for="K1">é«˜å‹ä¾§å˜æ¯”æ ¡æ­£ç³»æ•° (K1):</label>
                    <input type="number" id="K1" name="K1" value="0.7" step="0.001" min="0">
                </div>
                <div class="form-group">
                    <label for="K2">ä½å‹ä¾§å˜æ¯”æ ¡æ­£ç³»æ•° (K2):</label>
                    <input type="number" id="K2" name="K2" value="0.92" step="0.001" min="0">
                </div>
                <div class="form-group">
                    <label for="direction_choice">é«˜ä½å‹ç”µæµæ–¹å‘:</label>
                    <select id="direction_choice" name="direction_choice">
                        <option value="ç›¸åŒ">ç›¸åŒæ–¹å‘ï¼ˆä¸€æœŸæ€»å˜ï¼‰</option>
                        <option value="ç›¸å" selected>ç›¸åæ–¹å‘ï¼ˆäºŒæœŸæ€»å˜ï¼‰</option>
                    </select>
                </div>
            </div>

            <!-- æ ¡éªŒé€‰æ‹©é¢æ¿ -->
            <div class="panel">
                <div class="panel-title">âš¡ æ ¡éªŒé€‰æ‹©</div>
                <div class="form-group">
                    <label>æ ¡éªŒæ¨¡å¼:</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="single_phase" name="calibration_mode" value="single_phase" checked>
                            <label for="single_phase">åˆ†ç›¸æ ¡éªŒ</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="three_phase" name="calibration_mode" value="three_phase">
                            <label for="three_phase">ä¸‰ç›¸æ ¡éªŒ</label>
                        </div>
                    </div>
                </div>
                <div class="form-group" id="phase_selection">
                    <label>é€‰æ‹©æ ¡éªŒç›¸åˆ«:</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="phase_A" name="selected_phase" value="A" checked>
                            <label for="phase_A">Aç›¸</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="phase_B" name="selected_phase" value="B">
                            <label for="phase_B">Bç›¸</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="phase_C" name="selected_phase" value="C">
                            <label for="phase_C">Cç›¸</label>
                        </div>
                    </div>
                </div>
                <button class="btn" id="selectPointButton" onclick="selectPoint()">é€‰æ‹©æ ¡éªŒç‚¹</button>
                
                <div id="selectedPointDisplay" class="selected-point-display hidden">
                    <div class="selected-point-info" id="selectedPointInfo"></div>
                    <button class="btn" id="getResultsButton" onclick="getResults()">è®¡ç®—æ ¡éªŒç»“æœ</button>
                </div>
            </div>
        </div>

        <!-- æ ¡éªŒç»“æœé¢æ¿ -->
        <div class="panel">
            <div class="panel-title">ğŸ“‹ æ ¡éªŒç»“æœ</div>
            
            <div class="result-box">
                <div class="result-title">æ ¡éªŒç”µæµ</div>
                <div class="result-content" id="calibrationCurrentsBox">è¯·å…ˆé€‰æ‹©æ ¡éªŒç‚¹å¹¶è®¡ç®—ç»“æœ</div>
            </div>
            
            <div class="result-box">
                <div class="result-title">ä¿æŠ¤å™¨æ˜¾ç¤ºç”µæµ</div>
                <div class="result-content" id="relayDisplayCurrentsBox">è¯·å…ˆé€‰æ‹©æ ¡éªŒç‚¹å¹¶è®¡ç®—ç»“æœ</div>
            </div>
            
            <div class="result-box hidden" id="selectedPointInfoOutput">
                <div class="result-title">é€‰å–ç‚¹ä¿¡æ¯</div>
                <div class="result-content" id="selectedPointInfoContent"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // å…¨å±€å˜é‡å­˜å‚¨é€‰ä¸­çš„ç‚¹
        let selectedIbIn = null;
        let selectedIdIn = null;
        let currentChart = null;
        let chartModal = null;

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            updateUIVisibility();
            createChartModal();
            
            // ç›‘å¬æ ¡éªŒæ¨¡å¼å˜åŒ–
            document.querySelectorAll('input[name="calibration_mode"]').forEach(radio => {
                radio.addEventListener('change', updateUIVisibility);
            });
        });

        // åˆ›å»ºå›¾è¡¨æ¨¡æ€æ¡†
        function createChartModal() {
            const modalHTML = `
                <div id="chartModal" class="chart-modal hidden">
                    <div class="chart-modal-content">
                        <div class="chart-modal-header">
                            <h3>å·®åŠ¨ä¿æŠ¤ç‰¹æ€§æ›²çº¿</h3>
                            <button class="close-btn" onclick="closeChartModal()">&times;</button>
                        </div>
                        <div class="chart-container">
                            <canvas id="characteristicChart"></canvas>
                        </div>
                        <div class="chart-modal-footer">
                            <p>ç‚¹å‡»æ›²çº¿ä¸Šçš„ç‚¹æ¥é€‰æ‹©æ ¡éªŒç‚¹</p>
                            <button class="btn" onclick="closeChartModal()">å–æ¶ˆé€‰æ‹©</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            chartModal = document.getElementById('chartModal');
        }

        // æ›´æ–°UIå¯è§æ€§
        function updateUIVisibility() {
            const calibrationMode = document.querySelector('input[name="calibration_mode"]:checked').value;
            const phaseSelection = document.getElementById('phase_selection');
            
            if (calibrationMode === 'single_phase') {
                phaseSelection.classList.remove('hidden');
            } else {
                phaseSelection.classList.add('hidden');
            }
        }

        // å½’ä¸€åŒ–è§’åº¦åˆ°[-180, 180]
        function normalizeAngle(angle) {
            while (angle > 180) angle -= 360;
            while (angle <= -180) angle += 360;
            return angle;
        }

        // è®¡ç®—å·®åŠ¨ç‰¹æ€§æ›²çº¿
        function getIdIn(IbIn, P_IN, S, I2TP, ID_IN_HIGH_SET) {
            if (IbIn < 0) return 0;
            if (IbIn <= 0.5) return P_IN;
            if (IbIn <= I2TP) return P_IN + S * (IbIn - 0.5);
            
            const IdAtI2TP = P_IN + S * (I2TP - 0.5);
            const calculated = IdAtI2TP + 1 * (IbIn - I2TP);
            return Math.min(calculated, ID_IN_HIGH_SET);
        }

        // ç”Ÿæˆæ›²çº¿æ•°æ®
        function generateCurveData(P_IN, S, I2TP, ID_IN_HIGH_SET) {
            const maxX = Math.max(I2TP * 1.5, ID_IN_HIGH_SET * 1.2, 5);
            const points = [];
            const numPoints = 500;
            
            for (let i = 0; i <= numPoints; i++) {
                const IbIn = (i / numPoints) * maxX;
                const IdIn = getIdIn(IbIn, P_IN, S, I2TP, ID_IN_HIGH_SET);
                points.push({ x: IbIn, y: IdIn });
            }
            
            return points;
        }

        // ç”Ÿæˆè¾…åŠ©çº¿æ•°æ®
        function generateAuxiliaryLines(P_IN, I2TP, ID_IN_HIGH_SET, maxX) {
            return {
                P_IN_line: [
                    { x: 0, y: P_IN },
                    { x: 0.5, y: P_IN }
                ],
                vertical_05: [
                    { x: 0.5, y: 0 },
                    { x: 0.5, y: Math.max(P_IN, ID_IN_HIGH_SET) }
                ],
                vertical_I2TP: [
                    { x: I2TP, y: 0 },
                    { x: I2TP, y: Math.max(P_IN, ID_IN_HIGH_SET) }
                ],
                horizontal_high_set: [
                    { x: 0, y: ID_IN_HIGH_SET },
                    { x: maxX, y: ID_IN_HIGH_SET }
                ]
            };
        }

        // ç»˜åˆ¶ç‰¹æ€§æ›²çº¿
        function selectPoint() {
            const button = document.getElementById('selectPointButton');
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span> ç”Ÿæˆç‰¹æ€§æ›²çº¿...';

            try {
                // è·å–æ›²çº¿å®šå€¼å‚æ•°
                const P_IN = parseFloat(document.getElementById('P_IN').value);
                const S = parseFloat(document.getElementById('S').value);
                const I2TP = parseFloat(document.getElementById('I2TP').value);
                const ID_IN_HIGH_SET = parseFloat(document.getElementById('ID_IN_HIGH_SET').value);

                // éªŒè¯å‚æ•°
                if (isNaN(P_IN) || isNaN(S) || isNaN(I2TP) || isNaN(ID_IN_HIGH_SET)) {
                    throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼å‚æ•°');
                }

                // ç”Ÿæˆæ›²çº¿æ•°æ®
                const curveData = generateCurveData(P_IN, S, I2TP, ID_IN_HIGH_SET);
                const maxX = Math.max(I2TP * 1.5, ID_IN_HIGH_SET * 1.2, 5);
                const auxiliaryLines = generateAuxiliaryLines(P_IN, I2TP, ID_IN_HIGH_SET, maxX);

                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                chartModal.classList.remove('hidden');

                // åˆ›å»ºå›¾è¡¨
                const ctx = document.getElementById('characteristicChart').getContext('2d');
                
                // é”€æ¯ç°æœ‰å›¾è¡¨
                if (currentChart) {
                    currentChart.destroy();
                }

                currentChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: 'å·®åŠ¨ç‰¹æ€§æ›²çº¿',
                                data: curveData,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderWidth: 3,
                                fill: false,
                                pointRadius: 0,
                                pointHoverRadius: 6,
                                tension: 0
                            },
                            {
                                label: 'P_INçº¿',
                                data: auxiliaryLines.P_IN_line,
                                borderColor: 'rgb(255, 99, 132)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0,
                                showLine: true
                            },
                            {
                                label: '0.5çº¿',
                                data: auxiliaryLines.vertical_05,
                                borderColor: 'rgb(255, 206, 86)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0,
                                showLine: true
                            },
                            {
                                label: 'I2TPçº¿',
                                data: auxiliaryLines.vertical_I2TP,
                                borderColor: 'rgb(54, 162, 235)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0,
                                showLine: true
                            },
                            {
                                label: 'é«˜è®¾å®šçº¿',
                                data: auxiliaryLines.horizontal_high_set,
                                borderColor: 'rgb(153, 102, 255)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0,
                                showLine: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'nearest'
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                position: 'bottom',
                                title: {
                                    display: true,
                                    text: 'Ib/In (åˆ¶åŠ¨ç”µæµå€æ•°)'
                                },
                                grid: {
                                    display: true
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Id/In (å·®åŠ¨ç”µæµå€æ•°)'
                                },
                                grid: {
                                    display: true
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'ABB SPAD346C å·®åŠ¨ä¿æŠ¤ç‰¹æ€§æ›²çº¿'
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const element = elements[0];
                                if (element.datasetIndex === 0) { // åªå“åº”ä¸»æ›²çº¿çš„ç‚¹å‡»
                                    const point = curveData[element.index];
                                    selectPointOnCurve(point.x, point.y, P_IN, S, I2TP, ID_IN_HIGH_SET);
                                }
                            } else {
                                // ç‚¹å‡»ç©ºç™½åŒºåŸŸï¼Œè®¡ç®—æœ€è¿‘çš„æ›²çº¿ç‚¹
                                const canvasPosition = Chart.helpers.getRelativePosition(event, currentChart);
                                const dataX = currentChart.scales.x.getValueForPixel(canvasPosition.x);
                                const dataY = currentChart.scales.y.getValueForPixel(canvasPosition.y);
                                
                                if (dataX >= 0 && dataX <= maxX) {
                                    const calculatedY = getIdIn(dataX, P_IN, S, I2TP, ID_IN_HIGH_SET);
                                    selectPointOnCurve(dataX, calculatedY, P_IN, S, I2TP, ID_IN_HIGH_SET);
                                }
                            }
                        }
                    }
                });

                button.disabled = false;
                button.innerHTML = 'é‡æ–°é€‰æ‹©æ ¡éªŒç‚¹';

            } catch (error) {
                console.error('ç”Ÿæˆæ›²çº¿é”™è¯¯:', error);
                alert('ç”Ÿæˆæ›²çº¿æ—¶å‘ç”Ÿé”™è¯¯ï¼š' + error.message);
                button.disabled = false;
                button.innerHTML = 'é€‰æ‹©æ ¡éªŒç‚¹';
            }
        }

        // åœ¨æ›²çº¿ä¸Šé€‰æ‹©ç‚¹
        function selectPointOnCurve(IbIn, IdIn, P_IN, S, I2TP, ID_IN_HIGH_SET) {
            // ç¡®ä¿ç‚¹åœ¨æ›²çº¿ä¸Š
            const correctedIdIn = getIdIn(IbIn, P_IN, S, I2TP, ID_IN_HIGH_SET);
            
            selectedIbIn = IbIn;
            selectedIdIn = correctedIdIn;

            // åœ¨å›¾è¡¨ä¸Šæ·»åŠ é€‰ä¸­ç‚¹çš„æ ‡è®°
            if (currentChart) {
                // æ·»åŠ é€‰ä¸­ç‚¹æ•°æ®é›†
                const selectedPointData = [{ x: selectedIbIn, y: selectedIdIn }];
                
                // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­ç‚¹
                currentChart.data.datasets = currentChart.data.datasets.filter(dataset => 
                    dataset.label !== 'é€‰ä¸­ç‚¹'
                );
                
                // æ·»åŠ æ–°çš„é€‰ä¸­ç‚¹
                currentChart.data.datasets.push({
                    label: 'é€‰ä¸­ç‚¹',
                    data: selectedPointData,
                    backgroundColor: 'rgb(255, 0, 0)',
                    borderColor: 'rgb(255, 0, 0)',
                    pointRadius: 8,
                    pointHoverRadius: 10,
                    showLine: false
                });
                
                currentChart.update();
            }

            // æ›´æ–°é€‰ä¸­ç‚¹ä¿¡æ¯
            document.getElementById('selectedPointInfo').textContent = 
                `å·²é€‰æ‹©æ ¡éªŒç‚¹: Ib/In = ${selectedIbIn.toFixed(3)}, Id/In = ${selectedIdIn.toFixed(3)}`;
            
            // å…³é—­æ¨¡æ€æ¡†å¹¶æ˜¾ç¤ºç»“æœåŒºåŸŸ
            setTimeout(() => {
                closeChartModal();
                document.getElementById('selectedPointDisplay').classList.remove('hidden');
            }, 1000);
        }

        // å…³é—­å›¾è¡¨æ¨¡æ€æ¡†
        function closeChartModal() {
            chartModal.classList.add('hidden');
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
        }

        // è®¡ç®—é€šç”¨ç”µæµ
        function calculateCommonCurrents(selectedIbIn, selectedIdIn, IN, K1, K2) {
            const I1 = (2 * selectedIbIn + selectedIdIn) * IN / 2;
            const I2 = (2 * selectedIbIn - selectedIdIn) * IN / 2;
            const I1_prime = I1 * K1;
            const I2_prime = I2 * K2;
            
            return { I1, I2, I1_prime, I2_prime };
        }

        // è®¡ç®—åˆ†ç›¸æ ¡éªŒç”µæµ
        function calculateSinglePhaseTestCurrents(selectedIbIn, selectedIdIn, directionChoice, IN, K1, K2, selectedPhase) {
            const { I1, I2, I1_prime, I2_prime } = calculateCommonCurrents(selectedIbIn, selectedIdIn, IN, K1, K2);
            
            const HV_test_mag = I1_prime * Math.sqrt(3);
            const LV_test_mag = I2_prime;
            const LV_aux_mag = I1 * K2;

            let hv_phase_angle = 0;
            let lv_phase_angle = 180;
            let lv_aux_phase_angle = 0;

            // æ ¹æ®ç›¸åˆ«è°ƒæ•´ç›¸è§’
            if (selectedPhase === 'B') {
                hv_phase_angle = normalizeAngle(hv_phase_angle - 120);
                lv_phase_angle = normalizeAngle(lv_phase_angle - 120);
                lv_aux_phase_angle = normalizeAngle(lv_aux_phase_angle - 120);
            } else if (selectedPhase === 'C') {
                hv_phase_angle = normalizeAngle(hv_phase_angle + 120);
                lv_phase_angle = normalizeAngle(lv_phase_angle + 120);
                lv_aux_phase_angle = normalizeAngle(lv_aux_phase_angle + 120);
            }

            const phaseMap = { 'A': 'A', 'B': 'B', 'C': 'C' };
            const auxPhaseMap = { 'A': 'c', 'B': 'a', 'C': 'b' };
            const lowPhaseMap = { 'A': 'a', 'B': 'b', 'C': 'c' };

            return `åˆ†ç›¸æ ¡éªŒæ—¶åš${selectedPhase}ç›¸è¯•éªŒåŠ çš„ç”µæµ:
é«˜å‹ä¾§${phaseMap[selectedPhase]}ç›¸è¯•éªŒåŠ ç”µæµ I${phaseMap[selectedPhase]}: ${HV_test_mag.toFixed(2)}A âˆ ${hv_phase_angle}Â°
ä½å‹ä¾§${lowPhaseMap[selectedPhase]}ç›¸è¯•éªŒåŠ ç”µæµ I${lowPhaseMap[selectedPhase]}: ${LV_test_mag.toFixed(2)}A âˆ ${lv_phase_angle}Â°
ä½å‹ä¾§${auxPhaseMap[selectedPhase]}ç›¸è¾…åŠ©è¯•éªŒåŠ ç”µæµ I${auxPhaseMap[selectedPhase]}: ${LV_aux_mag.toFixed(2)}A âˆ ${lv_aux_phase_angle}Â°`;
        }

        // è®¡ç®—ä¸‰ç›¸æ ¡éªŒç”µæµ
        function calculateThreePhaseTestCurrents(selectedIbIn, selectedIdIn, directionChoice, IN, K1, K2) {
            const { I1, I2, I1_prime, I2_prime } = calculateCommonCurrents(selectedIbIn, selectedIdIn, IN, K1, K2);
            
            const HV_A_mag = I1_prime;
            const HV_B_mag = I1_prime;
            const HV_C_mag = I1_prime;
            const LV_a_mag = I2_prime;
            const LV_b_mag = I2_prime;
            const LV_c_mag = I2_prime;

            // é«˜å‹ä¾§ç›¸è§’ï¼ˆæ­£ç›¸åºï¼‰
            const HV_phase_A = 0;
            const HV_phase_B = -120;
            const HV_phase_C = 120;

            // ä½å‹ä¾§ç›¸è§’
            let base_phase_shift_lv_to_hv = -150;
            if (directionChoice === 'ç›¸åŒ') {
                base_phase_shift_lv_to_hv += 180;
            }

            const LV_phase_a = normalizeAngle(0 + base_phase_shift_lv_to_hv);
            const LV_phase_b = normalizeAngle(-120 + base_phase_shift_lv_to_hv);
            const LV_phase_c = normalizeAngle(120 + base_phase_shift_lv_to_hv);

            return `ä¸‰ç›¸ä¸€èµ·åšæ ¡éªŒç”µæµ:
é«˜å‹ä¾§è¯•éªŒç”µæµï¼š
IA: ${HV_A_mag.toFixed(2)}A âˆ ${HV_phase_A}Â°
IB: ${HV_B_mag.toFixed(2)}A âˆ ${HV_phase_B}Â°
IC: ${HV_C_mag.toFixed(2)}A âˆ ${HV_phase_C}Â°

ä½å‹ä¾§è¯•éªŒç”µæµï¼š
Ia: ${LV_a_mag.toFixed(2)}A âˆ ${LV_phase_a}Â°
Ib: ${LV_b_mag.toFixed(2)}A âˆ ${LV_phase_b}Â°
Ic: ${LV_c_mag.toFixed(2)}A âˆ ${LV_phase_c}Â°`;
        }

        // æ ¼å¼åŒ–ä¿æŠ¤å™¨æ˜¾ç¤ºç”µæµ
        function formatRelayDisplayCurrents(calibrationMode, selectedPhase, I1, I2, IN, selectedIdIn) {
            const I1_per_In = I1 / IN;
            const I2_per_In = I2 / IN;
            const Id_per_In = selectedIdIn;

            if (calibrationMode === 'single_phase') {
                let hvDisplay = '';
                let lvDisplay = '';
                
                if (selectedPhase === 'A') {
                    hvDisplay = `IA: ${I1_per_In.toFixed(2)} In\nIB: ${(0.00).toFixed(2)} In\nIC: ${(-I1_per_In).toFixed(2)} In`;
                    lvDisplay = `Ia: ${I2_per_In.toFixed(2)} In\nIb: ${(0.00).toFixed(2)} In\nIc: ${(-I1_per_In).toFixed(2)} In`;
                } else if (selectedPhase === 'B') {
                    hvDisplay = `IA: ${(-I1_per_In).toFixed(2)} In\nIB: ${I1_per_In.toFixed(2)} In\nIC: ${(0.00).toFixed(2)} In`;
                    lvDisplay = `Ia: ${(-I1_per_In).toFixed(2)} In\nIb: ${I2_per_In.toFixed(2)} In\nIc: ${(0.00).toFixed(2)} In`;
                } else if (selectedPhase === 'C') {
                    hvDisplay = `IA: ${(0.00).toFixed(2)} In\nIB: ${(-I1_per_In).toFixed(2)} In\nIC: ${I1_per_In.toFixed(2)} In`;
                    lvDisplay = `Ia: ${(0.00).toFixed(2)} In\nIb: ${(-I1_per_In).toFixed(2)} In\nIc: ${I2_per_In.toFixed(2)} In`;
                }

                return `é«˜å‹ä¾§æ˜¾ç¤ºç”µæµ:\n${hvDisplay}\n\nä½å‹ä¾§æ˜¾ç¤ºç”µæµ:\n${lvDisplay}\n\nå·®åŠ¨ç”µæµ:\n${selectedPhase}ç›¸å·®æµ: ${Id_per_In.toFixed(2)} In`;
            } else {
                return `é«˜å‹ä¾§æ˜¾ç¤ºç”µæµ:
IA: ${I1_per_In.toFixed(2)} In
IB: ${I1_per_In.toFixed(2)} In
IC: ${I1_per_In.toFixed(2)} In

ä½å‹ä¾§æ˜¾ç¤ºç”µæµ:
Ia: ${I2_per_In.toFixed(2)} In
Ib: ${I2_per_In.toFixed(2)} In
Ic: ${I2_per_In.toFixed(2)} In

å·®åŠ¨ç”µæµ:
Aç›¸å·®æµ: ${Id_per_In.toFixed(2)} In
Bç›¸å·®æµ: ${Id_per_In.toFixed(2)} In
Cç›¸å·®æµ: ${Id_per_In.toFixed(2)} In`;
            }
        }

        // æ ¼å¼åŒ–é€‰å–ç‚¹ä¿¡æ¯
        function formatSelectedPointInfo(selectedIbIn, selectedIdIn, I1, I2, I1_prime, I2_prime, K1, K2) {
            return `æ›²çº¿é€‰å–ç‚¹åæ ‡:
åˆ¶åŠ¨ç”µæµ Ib/In = ${selectedIbIn.toFixed(2)}
å·®åŠ¨ç”µæµ Id/In = ${selectedIdIn.toFixed(2)}

ä¿æŠ¤å™¨æŠ˜ç®—åé«˜ä½å‹ç”µæµ:
é«˜å‹ä¾§æŠ˜ç®—ç”µæµ I1 = ${I1.toFixed(2)} A
ä½å‹ä¾§æŠ˜ç®—ç”µæµ I2 = ${I2.toFixed(2)} A

å˜æ¯”æ ¡æ­£å‰é«˜ä½å‹ç”µæµ:
é«˜å‹ä¾§ç”µæµ (I1*${K1.toFixed(3)}) = ${I1_prime.toFixed(2)} A
ä½å‹ä¾§ç”µæµ (I2*${K2.toFixed(3)}) = ${I2_prime.toFixed(2)} A`;
        }

        // è®¡ç®—æ ¡éªŒç»“æœ
        function getResults() {
            if (selectedIbIn === null || selectedIdIn === null) {
                alert('è¯·å…ˆé€‰æ‹©æ ¡éªŒç‚¹ï¼');
                return;
            }

            const button = document.getElementById('getResultsButton');
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span> è®¡ç®—ä¸­...';

            try {
                // è·å–æ‰€æœ‰å‚æ•°
                const calibrationMode = document.querySelector('input[name="calibration_mode"]:checked').value;
                const selectedPhase = document.querySelector('input[name="selected_phase"]:checked')?.value || 'A';
                const directionChoice = document.getElementById('direction_choice').value;
                const IN = parseFloat(document.getElementById('IN').value);
                const K1 = parseFloat(document.getElementById('K1').value);
                const K2 = parseFloat(document.getElementById('K2').value);

                // è®¡ç®—é€šç”¨ç”µæµ
                const { I1, I2, I1_prime, I2_prime } = calculateCommonCurrents(selectedIbIn, selectedIdIn, IN, K1, K2);

                // è®¡ç®—æ ¡éªŒç”µæµ
                let calibrationCurrentsText;
                if (calibrationMode === 'single_phase') {
                    calibrationCurrentsText = calculateSinglePhaseTestCurrents(
                        selectedIbIn, selectedIdIn, directionChoice, IN, K1, K2, selectedPhase
                    );
                } else {
                    calibrationCurrentsText = calculateThreePhaseTestCurrents(
                        selectedIbIn, selectedIdIn, directionChoice, IN, K1, K2
                    );
                }

                // æ ¼å¼åŒ–ä¿æŠ¤å™¨æ˜¾ç¤ºç”µæµ
                const relayDisplayText = formatRelayDisplayCurrents(
                    calibrationMode, selectedPhase, I1, I2, IN, selectedIdIn
                );

                // æ ¼å¼åŒ–é€‰å–ç‚¹ä¿¡æ¯
                const selectedPointInfoText = formatSelectedPointInfo(
                    selectedIbIn, selectedIdIn, I1, I2, I1_prime, I2_prime, K1, K2
                );

                // æ›´æ–°æ˜¾ç¤º
                document.getElementById('calibrationCurrentsBox').textContent = calibrationCurrentsText;
                document.getElementById('relayDisplayCurrentsBox').textContent = relayDisplayText;
                document.getElementById('selectedPointInfoContent').textContent = selectedPointInfoText;
                document.getElementById('selectedPointInfoOutput').classList.remove('hidden');

                button.disabled = false;
                button.innerHTML = 'é‡æ–°è®¡ç®—ç»“æœ';

            } catch (error) {
                console.error('è®¡ç®—é”™è¯¯:', error);
                document.getElementById('calibrationCurrentsBox').innerHTML = 
                    '<div class="error">è®¡ç®—è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥å‚æ•°</div>';
                
                button.disabled = false;
                button.innerHTML = 'è®¡ç®—æ ¡éªŒç»“æœ';
            }
        }
    </script>
</body>
</html>